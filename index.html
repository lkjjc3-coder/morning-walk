<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ì•„ì¹¨ ì‚°ì±… ê¸°ë¡</title>
  <link rel="icon" href="data:,">
  <style>
    body { margin:0; font-family:system-ui,-apple-system,sans-serif; color:white; background:center/cover fixed no-repeat; }
    body::before { content:""; position:fixed; inset:0; background:rgba(0,0,0,0.55); z-index:-1; }

    header { padding:20px; text-align:center; font-size:22px; font-weight:bold; backdrop-filter:blur(6px); background:rgba(0,0,0,0.35); }

    nav { display:flex; justify-content:center; gap:16px; padding:10px; backdrop-filter:blur(6px); background:rgba(0,0,0,0.25); flex-wrap:wrap; }
    nav button { background:rgba(255,255,255,0.15); border:none; color:white; padding:8px 14px; border-radius:20px; cursor:pointer; }
    nav button:hover { background:rgba(255,255,255,0.3); }

    .container { max-width:1100px; margin:auto; padding:16px; }

    .card { background:rgba(0,0,0,0.45); border:1px solid rgba(255,255,255,0.15); border-radius:16px; padding:16px; margin-bottom:20px; backdrop-filter:blur(6px); }

    input, textarea { width:100%; margin-bottom:8px; color:white; background:rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.2); border-radius:8px; padding:8px; }

    textarea { resize:vertical; min-height:60px; }

    .helper { font-size:13px; opacity:0.8; margin-bottom:12px; }
    .status { font-size:14px; margin-top:6px; opacity:0.9; }

    .gallery { display:grid; grid-template-columns:repeat(auto-fill,minmax(260px,1fr)); gap:16px; }
    .gallery img { width:100%; height:200px; object-fit:cover; border-radius:12px; margin-bottom:8px; cursor:pointer; }

    .empty { opacity:0.7; padding:20px; text-align:center; }

    .stats-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(140px,1fr)); gap:12px; }
    .stat-box { background:rgba(255,255,255,0.1); padding:14px; border-radius:12px; text-align:center; }

    .month-grid { display:grid; grid-template-columns:repeat(6,1fr); gap:8px; margin-top:12px; }
    .month { background:rgba(255,255,255,0.1); padding:10px; border-radius:10px; text-align:center; font-size:14px; }

    .actions { display:flex; gap:8px; margin-top:8px; }
    .btn { flex:1; padding:8px; border-radius:8px; border:none; background:rgba(255,255,255,0.15); color:white; cursor:pointer; }
    .btn:hover { background:rgba(255,255,255,0.3); }

    .memo { font-size:14px; opacity:0.9; margin:6px 0 10px; line-height:1.4; }

    .date-group { margin-bottom:30px; }
    .date-title { margin:18px 0 8px; font-weight:bold; opacity:0.9; }

    .like-btn { margin-top:6px; background:rgba(255,255,255,0.15); border:none; color:white; padding:6px 10px; border-radius:12px; cursor:pointer; }
  </style>
</head>
<body>

<header>ğŸŒ… ì•„ì¹¨ ì‚°ì±… ê¸°ë¡</header>

<nav>
  <button onclick="scrollToTop()">í™ˆ</button>
  <button onclick="scrollToGallery()">ì‚°ì±… ê¸°ë¡</button>
  <button onclick="alert('í†µê³„ëŠ” ìœ„ì—ì„œ í™•ì¸í•˜ì„¸ìš”.')">í†µê³„</button>
</nav>

<div class="container">

  <div class="card">
    <h4>ğŸ“· ì‚°ì±… ì‚¬ì§„ ì—…ë¡œë“œ</h4>
    <input type="file" accept="image/*" id="photoInput">

    <textarea id="memoInput" placeholder="ì˜¤ëŠ˜ ì‚°ì±… ë¬µìƒì´ë‚˜ ëŠë‚Œì„ í•œ ì¤„ ë‚¨ê²¨ë³´ì„¸ìš”..."></textarea>

    <div class="helper">ì‚¬ì§„ + ë¬µìƒì„ í•¨ê»˜ ê¸°ë¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>

    <div class="actions">
      <button class="btn" onclick="exportRecords()">ê¸°ë¡ ë‚´ë³´ë‚´ê¸°</button>
      <button class="btn" onclick="importRecords()">ê¸°ë¡ ê°€ì ¸ì˜¤ê¸°</button>
    </div>

    <input placeholder="ğŸ” ë‚ ì§œ ë˜ëŠ” ë¬µìƒ ê²€ìƒ‰" id="searchInput">

    <div id="uploadStatus" class="status"></div>

    <hr style="margin:16px 0;border-color:rgba(255,255,255,0.2)">

    <h4>ğŸ–¼ ë°°ê²½ í™”ë©´ ì„¤ì •</h4>
    <input type="file" accept="image/*" id="bgInput">
    <div class="actions">
      <button class="btn" onclick="removeBackground()">ë°°ê²½ ì‚­ì œ</button>
    </div>

    <div class="stats-grid">
      <div class="stat-box">ì´ë²ˆ ë‹¬<br><b id="monthCount">0</b>íšŒ</div>
      <div class="stat-box">ì˜¬í•´ ê¸°ë¡<br><b id="yearCount">0</b>íšŒ</div>
      <div class="stat-box">ì—°ì† ì‚°ì±…<br><b id="streak">0</b>ì¼</div>
      <div class="stat-box">ì¶”ì • ê±°ë¦¬<br><b id="distance">0</b>km</div>
    </div>

    <h4 style="margin-top:18px">ğŸ“ˆ ì›”ë³„ ê¸°ë¡</h4>
    <div id="monthGrid" class="month-grid"></div>
  </div>

  <h3 id="galleryTitle">ğŸ“· ì‚°ì±… ê¸°ë¡</h3>
  <div id="gallery"></div>

</div>

<script>
const STORAGE_KEY="morning_walk_records";
const BG_KEY="morning_walk_bg";

let records=JSON.parse(localStorage.getItem(STORAGE_KEY)||"[]");
let searchKeyword="";

function save(){localStorage.setItem(STORAGE_KEY,JSON.stringify(records));}

function applyBackground(){
  const saved=localStorage.getItem(BG_KEY);
  document.body.style.backgroundImage = saved
    ? `url('${saved}')`
    : "url('https://images.unsplash.com/photo-1500530855697-b586d89ba3ee?q=80&w=1600')";
}

function removeBackground(){
  if(!confirm("ë°°ê²½ì„ ê¸°ë³¸ í™”ë©´ìœ¼ë¡œ ë°”ê¿€ê¹Œìš”?"))return;
  localStorage.removeItem(BG_KEY);
  applyBackground();
}

function today(){return new Date().toISOString().slice(0,10);}
function setStatus(m){document.getElementById("uploadStatus").textContent=m;}
function scrollToGallery(){document.getElementById("galleryTitle").scrollIntoView({behavior:"smooth"});}
function scrollToTop(){window.scrollTo({top:0,behavior:"smooth"});}

function renderStats(){
  const now=new Date();
  const monthKey=now.toISOString().slice(0,7);
  const yearKey=now.getFullYear().toString();

  const monthCount=records.filter(r=>r.date.startsWith(monthKey)).length;
  const yearRecords=records.filter(r=>r.date.startsWith(yearKey));

  document.getElementById("monthCount").textContent=monthCount;
  document.getElementById("yearCount").textContent=yearRecords.length;
  document.getElementById("distance").textContent=yearRecords.length*3;

  const uniqueDates=[...new Set(records.map(r=>r.date))].sort().reverse();
  let streak=0;
  if(uniqueDates.length){
    let cursor=new Date(uniqueDates[0]);
    for(let d of uniqueDates){
      const compare=new Date(d);
      const diff=(cursor-compare)/86400000;
      if(diff===0||diff===1){streak++;cursor.setDate(cursor.getDate()-1);} else break;
    }
  }
  document.getElementById("streak").textContent=streak;

  const monthly={};
  yearRecords.forEach(r=>{
    const m=r.date.slice(5,7);
    monthly[m]=(monthly[m]||0)+1;
  });

  const grid=document.getElementById("monthGrid");
  grid.innerHTML="";
  for(let i=1;i<=12;i++){
    const key=String(i).padStart(2,"0");
    const div=document.createElement("div");
    div.className="month";
    div.innerHTML=`${i}ì›”<br><b>${monthly[key]||0}</b>`;
    grid.appendChild(div);
  }
}

function deleteRecord(id){
  if(!confirm("ì‚­ì œí• ê¹Œìš”?"))return;
  records=records.filter(r=>r.id!==id);
  save(); renderAll();
}

function replaceImage(id){
  const input=document.createElement("input");
  input.type="file"; input.accept="image/*";
  input.onchange=e=>{
    const file=e.target.files[0]; if(!file)return;
    compressImage(file,data=>{
      const target=records.find(r=>r.id===id);
      if(target){target.image=data; save(); renderAll();}
    });
  };
  input.click();
}

function likeRecord(id){
  const r=records.find(x=>x.id===id);
  if(!r)return;
  r.likes=(r.likes||0)+1;
  save(); renderAll();
}

function renderGallery(){
  const container=document.getElementById("gallery");
  container.innerHTML="";

  let filtered=records.filter(r=>{
    const text=(r.memo||"").toLowerCase();
    return r.date.includes(searchKeyword)||text.includes(searchKeyword);
  });

  if(!filtered.length){
    container.innerHTML='<div class="empty">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
    return;
  }

  filtered.sort((a,b)=>b.date.localeCompare(a.date));

  const groups={};
  filtered.forEach(r=>{
    groups[r.date]=groups[r.date]||[];
    groups[r.date].push(r);
  });

  Object.keys(groups).sort().reverse().forEach(date=>{
    const groupDiv=document.createElement("div");
    groupDiv.className="date-group";

    const title=document.createElement("div");
    title.className="date-title";
    title.textContent=date;
    groupDiv.appendChild(title);

    const grid=document.createElement("div");
    grid.className="gallery";

    groups[date].forEach(r=>{
      const card=document.createElement("div");
      card.className="card";

      const img=document.createElement("img");
      img.src=r.image;
      img.onclick=()=>openViewer(r.image);

      const memo=document.createElement("div");
      memo.className="memo";
      memo.textContent=r.memo||"";

      const likeBtn=document.createElement("button");
      likeBtn.className="like-btn";
      likeBtn.textContent=`ğŸ™ ì€í˜œ ë°›ì•˜ìŠµë‹ˆë‹¤ (${r.likes||0})`;
      likeBtn.onclick=()=>likeRecord(r.id);

      const actions=document.createElement("div");
      actions.className="actions";

      const editBtn=document.createElement("button");
      editBtn.className="btn";
      editBtn.textContent="ì‚¬ì§„ ìˆ˜ì •";
      editBtn.onclick=()=>replaceImage(r.id);

      const delBtn=document.createElement("button");
      delBtn.className="btn";
      delBtn.textContent="ì‚­ì œ";
      delBtn.onclick=()=>deleteRecord(r.id);

      actions.appendChild(editBtn);
      actions.appendChild(delBtn);

      card.appendChild(img);
      card.appendChild(memo);
      card.appendChild(likeBtn);
      card.appendChild(actions);
      grid.appendChild(card);
    });

    groupDiv.appendChild(grid);
    container.appendChild(groupDiv);
  });
}

function renderAll(){renderStats();renderGallery(); setStatus(`í˜„ì¬ ê¸°ë¡ ${records.length}ê°œ`);} 

function compressImage(file,callback){
  const reader=new FileReader();
  reader.onload=e=>{
    const img=new Image();
    img.onload=()=>{
      const canvas=document.createElement("canvas");
      const ctx=canvas.getContext("2d");
      const MAX=1600;
      const scale=Math.min(1,MAX/Math.max(img.width,img.height));
      canvas.width=img.width*scale;
      canvas.height=img.height*scale;
      ctx.drawImage(img,0,0,canvas.width,canvas.height);
      callback(canvas.toDataURL("image/jpeg",0.82));
    };
    img.src=e.target.result;
  };
  reader.readAsDataURL(file);
}

// ì—…ë¡œë“œ
photoInput.addEventListener("change",e=>{
  const file=e.target.files[0]; if(!file)return;
  setStatus("ì‚¬ì§„ ì €ì¥ ì¤‘...");

  compressImage(file,data=>{
    records.push({
      id:Date.now(),
      date:today(),
      image:data,
      memo:document.getElementById("memoInput").value,
      likes:0
    });

    document.getElementById("memoInput").value="";
    save(); renderAll();
    setStatus("ì‚¬ì§„ ì €ì¥ ì™„ë£Œ âœ…");
    e.target.value="";
    setTimeout(scrollToGallery,300);
  });
});

// ê²€ìƒ‰
searchInput.addEventListener("input",e=>{
  searchKeyword=e.target.value.toLowerCase();
  renderGallery();
});

// ë°°ê²½ ì—…ë¡œë“œ
bgInput.addEventListener("change",e=>{
  const file=e.target.files[0]; if(!file)return;
  const reader=new FileReader();
  reader.onload=()=>{
    localStorage.setItem(BG_KEY,reader.result);
    applyBackground();
  };
  reader.readAsDataURL(file);
});

// ê³µìœ 
function exportRecords(){
  if(!records.length)return alert("ë‚´ë³´ë‚¼ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.");
  const blob=new Blob([JSON.stringify(records)],{type:"application/json"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url; a.download="morning-walk-records.json"; a.click();
  URL.revokeObjectURL(url);
}

function importRecords(){
  const input=document.createElement("input");
  input.type="file"; input.accept="application/json";
  input.onchange=e=>{
    const file=e.target.files[0]; if(!file)return;
    const reader=new FileReader();
    reader.onload=()=>{
      try{
        const incoming=JSON.parse(reader.result);
        records=incoming.concat(records);
        save(); renderAll();
        alert("ê¸°ë¡ ê°€ì ¸ì˜¤ê¸° ì™„ë£Œ");
      }catch{alert("ì˜¬ë°”ë¥¸ íŒŒì¼ì´ ì•„ë‹™ë‹ˆë‹¤.");}
    };
    reader.readAsText(file);
  };
  input.click();
}

applyBackground();
renderAll();
</script>

<div id="viewer" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.9);z-index:9999;align-items:center;justify-content:center;">
  <img id="viewerImg" style="max-width:95%;max-height:95%;border-radius:12px;" />
</div>

<script>
function openViewer(src){
  const viewer=document.getElementById("viewer");
  const img=document.getElementById("viewerImg");
  img.src=src; viewer.style.display="flex";
}

document.getElementById("viewer").onclick=()=>{
  document.getElementById("viewer").style.display="none";
};
</script>

</body>
</html>
