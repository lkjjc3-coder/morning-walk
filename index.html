import React, { useEffect, useMemo, useState } from "react";
import {
  LineChart,
  Line,
  XAxis,
  YAxis,
  Tooltip,
  ResponsiveContainer,
} from "recharts";

/* =====================================================
   ğŸŒ… Morning Walk App â€” ì•ˆì •í™” ë²„ì „
   ì™¸ë¶€ UI ë¼ì´ë¸ŒëŸ¬ë¦¬ ì œê±°í•˜ì—¬ ë¹ˆ í™”ë©´ ë¬¸ì œ í•´ê²°
===================================================== */

const STORAGE_KEY = "morning_walk_records";

/* ê°„ë‹¨í•œ ì¹´ë“œ ì»´í¬ë„ŒíŠ¸ (ë¼ì´ë¸ŒëŸ¬ë¦¬ ì˜ì¡´ì„± ì œê±°) */
function Card({ children }) {
  return (
    <div className="rounded-3xl bg-white/5 border border-white/10 backdrop-blur-md">
      {children}
    </div>
  );
}

function CardContent({ children }) {
  return <div className="p-8">{children}</div>;
}

export default function MorningWalkApp() {
  const [walkRecords, setWalkRecords] = useState([]);

  /* =========================
     localStorage ë¡œë”©
  ========================= */
  useEffect(() => {
    try {
      const saved = localStorage.getItem(STORAGE_KEY);
      if (saved) setWalkRecords(JSON.parse(saved));
    } catch (e) {
      console.error("Storage load error", e);
    }
  }, []);

  useEffect(() => {
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(walkRecords));
    } catch (e) {
      console.error("Storage save error", e);
    }
  }, [walkRecords]);

  /* =========================
     ë‚ ì§œ ì •ë ¬
  ========================= */
  const sortedRecords = useMemo(() => {
    return [...walkRecords].sort(
      (a, b) => new Date(b.date) - new Date(a.date)
    );
  }, [walkRecords]);

  /* =========================
     ì¥ì†Œ ê·¸ë£¹í™”
  ========================= */
  const groupedByPlace = useMemo(() => {
    const map = {};

    sortedRecords.forEach((r) => {
      const key = r.location?.name || "ê¸°íƒ€ ì¥ì†Œ";
      if (!map[key]) map[key] = [];
      map[key].push(r);
    });

    return map;
  }, [sortedRecords]);

  /* =========================
     í†µê³„ ê³„ì‚°
  ========================= */
  const now = new Date();
  const currentMonth = now.toISOString().slice(0, 7);
  const currentYear = now.getFullYear().toString();

  const thisMonthRecords = sortedRecords.filter((r) =>
    r.date.startsWith(currentMonth)
  );

  const thisYearRecords = sortedRecords.filter((r) =>
    r.date.startsWith(currentYear)
  );

  /* ì—°ì† ì‚°ì±… ê³„ì‚° */
  const uniqueDates = [...new Set(sortedRecords.map((r) => r.date))]
    .sort()
    .reverse();

  let streak = 0;
  if (uniqueDates.length) {
    let cursor = new Date(uniqueDates[0]);

    for (let d of uniqueDates) {
      const compare = new Date(d);
      const diff = (cursor - compare) / (1000 * 60 * 60 * 24);

      if (diff === 0 || diff === 1) {
        streak++;
        cursor.setDate(cursor.getDate() - 1);
      } else break;
    }
  }

  /* ì›”ë³„ ê·¸ë˜í”„ ë°ì´í„° */
  const monthlyMap = {};
  thisYearRecords.forEach((r) => {
    const m = r.date.slice(5, 7);
    monthlyMap[m] = (monthlyMap[m] || 0) + 1;
  });

  const chartData = Array.from({ length: 12 }).map((_, i) => {
    const key = String(i + 1).padStart(2, "0");
    return {
      month: `${i + 1}ì›”`,
      count: monthlyMap[key] || 0,
    };
  });

  /* ê±°ë¦¬ ì¶”ì • */
  const estimatedDistance = thisYearRecords.length * 3;

  /* ì§€ë„ ì¥ì†Œ ëª©ë¡ */
  const mapPoints = useMemo(() => {
    const result = [];

    Object.values(groupedByPlace).forEach((records) => {
      const r = records[0];
      if (r.location?.lat && r.location?.lng) {
        result.push(r.location);
      }
    });

    return result;
  }, [groupedByPlace]);

  /* =========================
     ì‚¬ì§„ ì—…ë¡œë“œ
  ========================= */
  const addWalkRecord = (file) => {
    const today = new Date().toISOString().slice(0, 10);

    const newRecord = {
      id: Date.now(),
      date: today,
      title: "ì‚°ì±… ê¸°ë¡",
      image: URL.createObjectURL(file),
      location: { name: "ìœ„ì¹˜ ë¯¸ì§€ì •" },
    };

    setWalkRecords((prev) => [newRecord, ...prev]);
  };

  return (
    <main className="min-h-screen bg-black text-white p-6 space-y-12">
      {/* ì—…ë¡œë“œ */}
      <section className="max-w-7xl mx-auto">
        <input
          type="file"
          accept="image/*"
          capture="environment"
          onChange={(e) => {
            const file = e.target.files?.[0];
            if (file) addWalkRecord(file);
          }}
          className="mb-6"
        />
      </section>

      {/* í†µê³„ */}
      <section className="max-w-7xl mx-auto space-y-8">
        <Card>
          <CardContent>
            <div className="grid md:grid-cols-4 gap-6 text-center">
              <div>
                <p className="text-sm text-gray-400">ì´ë²ˆ ë‹¬ ì‚°ì±…</p>
                <p className="text-3xl font-bold mt-2">
                  {thisMonthRecords.length}íšŒ
                </p>
              </div>

              <div>
                <p className="text-sm text-gray-400">ì˜¬í•´ ì‚°ì±…</p>
                <p className="text-3xl font-bold mt-2">
                  {thisYearRecords.length}íšŒ
                </p>
              </div>

              <div>
                <p className="text-sm text-gray-400">ì—°ì† ì‚°ì±…</p>
                <p className="text-3xl font-bold mt-2">{streak}ì¼</p>
              </div>

              <div>
                <p className="text-sm text-gray-400">ì´ ê±°ë¦¬(ì¶”ì •)</p>
                <p className="text-3xl font-bold mt-2">
                  {estimatedDistance} km
                </p>
              </div>
            </div>
          </CardContent>
        </Card>

        <Card>
          <CardContent>
            <h4 className="text-lg font-semibold mb-4">
              ğŸ“ˆ ì›”ë³„ ì‚°ì±… íšŸìˆ˜
            </h4>
            <div className="w-full h-72">
              <ResponsiveContainer width="100%" height="100%">
                <LineChart data={chartData}>
                  <XAxis dataKey="month" />
                  <YAxis allowDecimals={false} />
                  <Tooltip />
                  <Line
                    type="monotone"
                    dataKey="count"
                    strokeWidth={2}
                  />
                </LineChart>
              </ResponsiveContainer>
            </div>
          </CardContent>
        </Card>
      </section>

      {/* ì¥ì†Œ */}
      <section className="max-w-7xl mx-auto">
        <Card>
          <CardContent>
            <h4 className="text-lg font-semibold mb-4">
              ğŸ“ ì‚°ì±… ì¥ì†Œ ëª©ë¡
            </h4>

            <ul className="mt-4 space-y-1 text-sm">
              {mapPoints.map((p, idx) => (
                <li key={idx}>
                  â€¢ {p.name} ({p.lat}, {p.lng})
                </li>
              ))}
            </ul>
          </CardContent>
        </Card>
      </section>

      {/* ê°¤ëŸ¬ë¦¬ */}
      <section className="max-w-7xl mx-auto">
        <h3 className="text-xl font-semibold mb-6">
          ğŸŒ… ìµœì‹  ì‚°ì±… ê¸°ë¡
        </h3>

        <div className="grid md:grid-cols-3 gap-6">
          {sortedRecords.map((r) => (
            <Card key={r.id}>
              <div className="p-4">
                {r.image && (
                  <img
                    src={r.image}
                    alt={r.title}
                    className="w-full h-48 object-cover rounded-xl mb-3"
                  />
                )}
                <p className="font-semibold">{r.title}</p>
                <p className="text-sm text-gray-400">{r.date}</p>
                <p className="text-sm text-gray-400">
                  {r.location?.name}
                </p>
              </div>
            </Card>
          ))}
        </div>
      </section>
    </main>
  );
}
